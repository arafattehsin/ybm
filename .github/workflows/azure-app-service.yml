name: Deploy to Azure App Service

on:
    push:
        branches:
            - main
    workflow_dispatch:

env:
    AZURE_WEBAPP_NAME: ybm-production
    NODE_VERSION: "20.x"

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Build Next.js application
              run: npm run build
              env:
                  NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL }}
                  COSMOS_DB_ENDPOINT: ${{ secrets.COSMOS_DB_ENDPOINT }}
                  COSMOS_DB_KEY: ${{ secrets.COSMOS_DB_KEY }}
                  COSMOS_DB_DATABASE_NAME: ${{ secrets.COSMOS_DB_DATABASE_NAME }}
                  STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
                  INSTAGRAM_APP_ID: ${{ secrets.INSTAGRAM_APP_ID }}
                  INSTAGRAM_USER_ID: ${{ secrets.INSTAGRAM_USER_ID }}
                  INSTAGRAM_ACCESS_TOKEN: ${{ secrets.INSTAGRAM_ACCESS_TOKEN }}

            - name: Prepare deployment package
              run: |
                  cp package.json .next/standalone/
                  cp package-lock.json .next/standalone/
                  cp -r .next/static .next/standalone/.next/
                  cp -r public .next/standalone/

            - name: Deploy to Azure Web App
              uses: azure/webapps-deploy@v2
              with:
                  app-name: ${{ env.AZURE_WEBAPP_NAME }}
                  publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
                  package: .next/standalone
